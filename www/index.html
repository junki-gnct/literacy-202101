<!DOCTYPE html>
<html lang="ja">
    <head>
        <link href="https://fonts.googleapis.com/css?family=Roboto:100,300,400,500,700,900" rel="stylesheet">
        <link href="https://cdn.jsdelivr.net/npm/@mdi/font@4.x/css/materialdesignicons.min.css" rel="stylesheet">
        <link href="https://cdn.jsdelivr.net/npm/vuetify@2.x/dist/vuetify.min.css" rel="stylesheet">
        <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, minimal-ui">
        <meta charset="utf-8">
        <title>Literacy 2020/01</title>
    </head>
    <body>
        <div id="app">
            <v-app>
                <v-main>
                    <v-container>
                        <v-row class="text-center">
                            <v-col class="mb-5" cols="12">
                                <h2 class="headline font-weight-bold mb-3">
                                    Log
                                </h2>
                                <v-row justify="center">
                                    <v-col v-for="(value, key) in users" :key="key" cols="6">
                                        <v-card color="#385F73" dark>
                                            <v-card-title class="headline">
                                                User: {{ key }}
                                            </v-card-title>
    
                                            <v-card-subtitle>
                                                Value: {{ value.value }}
                                            </v-card-subtitle>
                                        </v-card>
                                    </v-col>
                                </v-row>
                            </v-col>

                            <v-col class="mb-4">
                                <h1 class="display-2 font-weight-bold mb-3">
                                    Hello World!
                                </h1>
                            </v-col>

                            <v-col class="mb-5" cols="12">
                                <h2 class="headline font-weight-bold mb-3">
                                    Buttons
                                </h2>

                                <v-row justify="center">
                                    <a href="https://yahoo.co.jp/">
                                        <v-btn color="primary" elevation="2" class="subheading mx-3">
                                            Button 1 (Yahoo)
                                        </v-btn>
                                    </a>
                                    <a href="https://google.co.jp/" target="_blank" rel="noopener noreferrer">
                                        <v-btn color="primary" elevation="2" class="subheading mx-3">
                                            Button 2 (Google)
                                        </v-btn>
                                    </a>
                                </v-row>
                            </v-col>
                        </v-row>
                    </v-container>
                </v-main>
            </v-app>
        </div>

        <script src="https://cdn.jsdelivr.net/npm/vue@2.x/dist/vue.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/vuetify@2.x/dist/vuetify.js"></script>
        <script>
            window.onload = (() => {
                new Vue({
                    el: '#app',
                    vuetify: new Vuetify(),
                    data: {
                        websocket: null,
                        users: {},
                        isConnecting: true,
                        isConnected: false,
                        isDisconnected: false,
                    },
                    methods: {
                        handleMessage: function(data) {
                            if(data.name && data.value) {
                                this.$set(this.users, data.name, { name: data.name, value: data.value });
                            }
                            /*
                            if(data.message) {
                                console.log(data.message);
                                const name = Math.floor(Math.random() * Math.floor(125000));
                                this.$set(this.users, name, { data: data.message });
                            } else 
                            */
                        }
                    },

                    //
                    // 対応表
                    //
                    // isConnected, isConnecting, isDisconnected
                    // 0            1             0               -> 接続中       (!isConnected && isConnecting && !isDisconnected)
                    // 1            0             0               -> 接続済み     (isConnected && !isConnecting && !isDisconnected)
                    // 0            0             1               -> 接続エラー   (!isConnected && !isConnecting && isDisconnected)
                    // 1            0             1               -> 切断         (isConnected && !isConnecting && isDisconnected)
                    //
                    created: function() {
                        this.websocket = new WebSocket('wss://' + location.hostname + '/api/ws');
                        const webSocket = this.websocket;

                        webSocket.onopen = ((e) => {
                            this.isConnected = true;
                            this.isConnecting = false;
                            
                        });

                        webSocket.onmessage = ((e) => {
                            if(e && e.data) {
                                this.handleMessage(JSON.parse(e.data));
                            }
                        });

                        webSocket.onerror = ((e) => {
                            this.isConnected = false;
                            this.isConnecting = false;
                            this.isDisconnected = true;
                        })

                        webSocket.onclose = ((e) => {
                            this.isDisconnected = false;
                        })
                    }
                })
            })
        </script>
    </body>
</html>